<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Visual Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f0f0f0;
            overflow-x: hidden;
        }

        .editor-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 320px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .edit-toggle {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .edit-toggle.active {
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(39, 174, 96, 0); }
            100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); }
        }

        .toolbar-info {
            flex: 1;
            font-size: 14px;
            opacity: 0.9;
        }

        .content-area {
            flex: 1;
            padding: 20px;
            background: white;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            overflow-y: auto;
            position: relative;
        }

        /* Enhanced Editable Styles */
        .editable {
            outline: none;
            cursor: text;
            transition: all 0.3s ease;
            min-height: 24px;
            padding: 8px;
            border-radius: 6px;
            position: relative;
        }

        .editable:hover {
            background-color: rgba(52, 152, 219, 0.1);
            outline: 2px dashed #3498db;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
        }

        .editable:focus {
            background-color: rgba(52, 152, 219, 0.15);
            outline: 3px solid #3498db;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }

        .editable.editing {
            background-color: rgba(46, 204, 113, 0.1);
            outline: 3px solid #2ecc71;
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.3);
        }

        /* Advanced Image Editing */
        .editable-image {
            position: relative;
            display: inline-block;
            cursor: move;
            transition: all 0.3s ease;
            border-radius: 8px;
            overflow: hidden;
        }

        .editable-image img {
            display: block;
            max-width: 100%;
            height: auto;
            transition: all 0.3s ease;
        }

        .editable-image:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            outline: 3px dashed #3498db;
        }

        .editable-image.selected {
            outline: 3px solid #e74c3c;
            box-shadow: 0 15px 40px rgba(231, 76, 60, 0.4);
            transform: translateY(-5px);
        }

        .editable-image.dragging {
            opacity: 0.8;
            transform: scale(0.95) rotate(2deg);
            z-index: 1000;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        /* Enhanced Image Controls */
        .image-controls {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            padding: 8px;
            border-radius: 25px;
            display: none;
            gap: 5px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .editable-image.selected .image-controls {
            display: flex;
        }

        .image-control-btn {
            background: transparent;
            border: none;
            color: white;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-control-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        .image-control-btn.danger {
            color: #e74c3c;
        }

        .image-control-btn.danger:hover {
            background: rgba(231, 76, 60, 0.2);
        }

        /* Resize Handles */
        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #3498db;
            border: 2px solid white;
            border-radius: 50%;
            cursor: nw-resize;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .resize-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
        .resize-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }

        .editable-image.selected .resize-handle {
            display: block;
        }

        /* Sidebar Styling */
        .sidebar h2 {
            color: #ecf0f1;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #34495e;
            font-size: 22px;
        }

        .sidebar h3 {
            color: #bdc3c7;
            margin: 25px 0 15px 0;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 16px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            width: 100%;
            text-align: left;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
        }

        .btn.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn.danger:hover {
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .btn.success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .btn.success:hover {
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        }

        /* File Upload Area */
        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin: 15px 0;
            background: rgba(52, 152, 219, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #2980b9;
            background: rgba(52, 152, 219, 0.1);
            transform: scale(1.02);
        }

        .upload-area.dragover {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
            transform: scale(1.05);
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-text {
            color: #3498db;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #7f8c8d;
            font-size: 14px;
        }

        /* Properties Panel */
        .properties-panel {
            background: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }

        .properties-panel h4 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .property-group {
            margin-bottom: 12px;
        }

        .property-group label {
            display: block;
            font-size: 12px;
            color: #34495e;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .property-group input,
        .property-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        /* Drop Zones */
        .drop-zone {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(52, 152, 219, 0.2);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            border: 5px dashed #3498db;
        }

        .drop-zone.active {
            display: flex;
        }

        .drop-zone-content {
            background: white;
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .drop-zone-icon {
            font-size: 64px;
            color: #3498db;
            margin-bottom: 20px;
        }

        /* Modal Styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-title {
            font-size: 24px;
            color: #2c3e50;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: #ecf0f1;
            color: #e74c3c;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            z-index: 10001;
            transform: translateX(400px);
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #27ae60;
        }

        .toast.error {
            background: #e74c3c;
        }

        .toast.warning {
            background: #f39c12;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .editor-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
            }
            
            .content-area {
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <div class="sidebar">
            <h2>🎨 Visual Editor</h2>
            
            <div class="properties-panel">
                <h4>💡 Quick Start</h4>
                <p style="color: #bdc3c7; font-size: 13px; line-height: 1.4;">
                    1. Click "Enable Editing" below<br>
                    2. Click any text to edit it<br>
                    3. Click images to move, resize, or replace them<br>
                    4. Drag new images into the editor
                </p>
            </div>

            <h3>🔧 Edit Controls</h3>
            <button onclick="toggleEditMode()" class="btn" id="editModeBtn">
                📝 Enable Editing
            </button>
            <button onclick="saveChanges()" class="btn success">
                💾 Save Changes
            </button>
            <button onclick="previewMode()" class="btn">
                👁️ Preview Mode
            </button>
            <button onclick="undoChanges()" class="btn">
                ↩️ Undo Last Change
            </button>

            <h3>🖼️ Image Tools</h3>
            <div class="upload-area" onclick="document.getElementById('imageUpload').click()">
                <input type="file" id="imageUpload" accept="image/*" multiple onchange="handleImageUpload(event)">
                <div class="upload-text">📁 Browse Images</div>
                <div class="upload-hint">Click to select images or drag them here</div>
            </div>
            
            <button onclick="addImageFromUrl()" class="btn">
                🔗 Add Image from URL
            </button>
            <button onclick="optimizeAllImages()" class="btn">
                ⚡ Optimize All Images
            </button>
            <button onclick="alignAllImages('center')" class="btn">
                🎯 Center All Images
            </button>
            <button onclick="resizeAllImages()" class="btn">
                📏 Resize All Images
            </button>

            <h3>📝 Text Tools</h3>
            <button onclick="makeAllTextEditable()" class="btn">
                ✏️ Make All Text Editable
            </button>
            <button onclick="formatAllHeadings()" class="btn">
                🎨 Format Headings
            </button>
            <button onclick="fixTextSpacing()" class="btn">
                📐 Fix Text Spacing
            </button>

            <h3>🎨 Style Tools</h3>
            <button onclick="applyTheme('modern')" class="btn">
                🌟 Modern Theme
            </button>
            <button onclick="applyTheme('classic')" class="btn">
                📚 Classic Theme
            </button>
            <button onclick="resetStyles()" class="btn danger">
                🔄 Reset All Styles
            </button>

            <div class="properties-panel" id="selectedElementProps" style="display: none;">
                <h4>🎯 Selected Element</h4>
                <div id="propsContent"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="toolbar">
                <button onclick="toggleEditMode()" class="edit-toggle" id="editToggle">
                    Enable Editing
                </button>
                <div class="toolbar-info">
                    <span id="editStatus">Click to start editing</span>
                </div>
                <button onclick="window.location.href='index.html'" class="btn" style="width: auto; margin: 0;">
                    🏠 Back to Website
                </button>
            </div>

            <div class="content-area" id="content">
                <!-- Website content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Drop Zone -->
    <div class="drop-zone" id="dropZone">
        <div class="drop-zone-content">
            <div class="drop-zone-icon">📁</div>
            <h3>Drop Images Here</h3>
            <p>Release to add images to your website</p>
        </div>
    </div>

    <!-- Image Properties Modal -->
    <div class="modal" id="imageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🖼️ Image Properties</h3>
                <button class="close-btn" onclick="closeModal('imageModal')">&times;</button>
            </div>
            <div id="imagePropsForm">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- URL Input Modal -->
    <div class="modal" id="urlModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🔗 Add Image from URL</h3>
                <button class="close-btn" onclick="closeModal('urlModal')">&times;</button>
            </div>
            <div class="property-group">
                <label>Image URL:</label>
                <input type="url" id="imageUrl" placeholder="https://example.com/image.jpg">
            </div>
            <div class="property-group">
                <label>Alt Text:</label>
                <input type="text" id="imageAlt" placeholder="Description of the image">
            </div>
            <div style="margin-top: 20px;">
                <button onclick="addImageFromUrlSubmit()" class="btn success">Add Image</button>
                <button onclick="closeModal('urlModal')" class="btn" style="margin-left: 10px;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        console.log('🎨 Advanced Visual Editor Loaded');
        
        let isEditMode = false;
        let selectedElement = null;
        let draggedElement = null;
        let undoStack = [];
        let isResizing = false;
        let resizeData = {};

        // Initialize editor
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing editor...');
            loadWebsiteContent();
            setupDragAndDrop();
            setupKeyboardShortcuts();
            showToast('Editor loaded successfully!', 'success');
        });

        // Load website content
        function loadWebsiteContent() {
            fetch('index.html')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const content = doc.querySelector('main') || doc.body;
                    
                    document.getElementById('content').innerHTML = content.innerHTML;
                    setupEditableElements();
                    console.log('Website content loaded');
                })
                .catch(error => {
                    console.error('Error loading content:', error);
                    showToast('Error loading website content', 'error');
                });
        }

        // Setup editable elements
        function setupEditableElements() {
            const elements = document.querySelectorAll('#content *');
            elements.forEach(element => {
                if (element.tagName.match(/^(H[1-6]|P|SPAN|DIV|A|LI)$/)) {
                    if (!element.classList.contains('editable')) {
                        element.classList.add('editable');
                        element.setAttribute('contenteditable', 'false');
                    }
                }
                
                if (element.tagName === 'IMG') {
                    setupImageElement(element);
                }
            });
            console.log('Editable elements setup complete');
        }

        // Setup image elements with advanced features
        function setupImageElement(img) {
            const wrapper = document.createElement('div');
            wrapper.className = 'editable-image';
            img.parentNode.insertBefore(wrapper, img);
            wrapper.appendChild(img);

            // Add controls
            const controls = document.createElement('div');
            controls.className = 'image-controls';
            controls.innerHTML = `
                <button class="image-control-btn" onclick="openImageProperties(this)" title="Properties">⚙️</button>
                <button class="image-control-btn" onclick="replaceImage(this)" title="Replace">🔄</button>
                <button class="image-control-btn" onclick="duplicateImage(this)" title="Duplicate">📋</button>
                <button class="image-control-btn" onclick="cropImage(this)" title="Crop">✂️</button>
                <button class="image-control-btn danger" onclick="deleteImage(this)" title="Delete">🗑️</button>
            `;
            wrapper.appendChild(controls);

            // Add resize handles
            ['nw', 'ne', 'sw', 'se'].forEach(direction => {
                const handle = document.createElement('div');
                handle.className = `resize-handle ${direction}`;
                handle.addEventListener('mousedown', startResize);
                wrapper.appendChild(handle);
            });

            // Add drag functionality
            wrapper.draggable = true;
            wrapper.addEventListener('dragstart', handleImageDragStart);
            wrapper.addEventListener('dragend', handleImageDragEnd);
            wrapper.addEventListener('click', selectImage);

            console.log('Image element setup:', img.src);
        }

        // Toggle edit mode
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const editToggle = document.getElementById('editToggle');
            const editModeBtn = document.getElementById('editModeBtn');
            const editStatus = document.getElementById('editStatus');
            
            if (isEditMode) {
                editToggle.textContent = 'Disable Editing';
                editToggle.classList.add('active');
                editModeBtn.textContent = '🔒 Disable Editing';
                editStatus.textContent = 'Editing enabled - click elements to edit';
                enableAllEditing();
                showToast('Editing mode enabled!', 'success');
            } else {
                editToggle.textContent = 'Enable Editing';
                editToggle.classList.remove('active');
                editModeBtn.textContent = '📝 Enable Editing';
                editStatus.textContent = 'Click to start editing';
                disableAllEditing();
                deselectAll();
                showToast('Editing mode disabled', 'warning');
            }
        }

        // Enable all editing
        function enableAllEditing() {
            document.querySelectorAll('.editable').forEach(el => {
                el.setAttribute('contenteditable', 'true');
                el.addEventListener('input', saveToUndoStack);
            });
        }

        // Disable all editing
        function disableAllEditing() {
            document.querySelectorAll('.editable').forEach(el => {
                el.setAttribute('contenteditable', 'false');
                el.classList.remove('editing');
            });
        }

        // Image handling functions
        function handleImageUpload(event) {
            const files = event.target.files;
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        addImageToContent(e.target.result, file.name);
                    };
                    reader.readAsDataURL(file);
                }
            });
            event.target.value = ''; // Reset input
        }

        function addImageToContent(src, filename) {
            const img = document.createElement('img');
            img.src = src;
            img.alt = filename || 'Uploaded image';
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.margin = '10px';
            
            const content = document.getElementById('content');
            content.appendChild(img);
            
            setupImageElement(img);
            showToast(`Image "${filename}" added successfully!`, 'success');
            saveToUndoStack();
        }

        function addImageFromUrl() {
            document.getElementById('urlModal').classList.add('active');
        }

        function addImageFromUrlSubmit() {
            const url = document.getElementById('imageUrl').value;
            const alt = document.getElementById('imageAlt').value;
            
            if (url) {
                addImageToContent(url, alt || 'Image from URL');
                closeModal('urlModal');
                document.getElementById('imageUrl').value = '';
                document.getElementById('imageAlt').value = '';
            }
        }

        // Image selection and properties
        function selectImage(event) {
            if (!isEditMode) return;
            
            event.stopPropagation();
            deselectAll();
            
            const wrapper = event.currentTarget;
            wrapper.classList.add('selected');
            selectedElement = wrapper;
            
            showImageProperties(wrapper);
        }

        function deselectAll() {
            document.querySelectorAll('.editable-image.selected').forEach(el => {
                el.classList.remove('selected');
            });
            selectedElement = null;
            document.getElementById('selectedElementProps').style.display = 'none';
        }

        function showImageProperties(wrapper) {
            const img = wrapper.querySelector('img');
            const propsPanel = document.getElementById('selectedElementProps');
            const propsContent = document.getElementById('propsContent');
            
            propsContent.innerHTML = \`
                <div class="property-group">
                    <label>Width:</label>
                    <input type="number" value="\${img.offsetWidth}" onchange="updateImageProperty('width', this.value + 'px')">
                </div>
                <div class="property-group">
                    <label>Height:</label>
                    <input type="number" value="\${img.offsetHeight}" onchange="updateImageProperty('height', this.value + 'px')">
                </div>
                <div class="property-group">
                    <label>Alt Text:</label>
                    <input type="text" value="\${img.alt}" onchange="updateImageProperty('alt', this.value)">
                </div>
                <div class="property-group">
                    <label>Border Radius:</label>
                    <input type="range" min="0" max="50" value="0" onchange="updateImageProperty('borderRadius', this.value + 'px')">
                </div>
                <div class="property-group">
                    <label>Opacity:</label>
                    <input type="range" min="0" max="100" value="100" onchange="updateImageProperty('opacity', this.value / 100)">
                </div>
            \`;
            
            propsPanel.style.display = 'block';
        }

        function updateImageProperty(property, value) {
            if (!selectedElement) return;
            
            const img = selectedElement.querySelector('img');
            if (property === 'alt') {
                img.alt = value;
            } else {
                img.style[property] = value;
            }
            saveToUndoStack();
        }

        // Drag and drop functionality
        function setupDragAndDrop() {
            const content = document.getElementById('content');
            const dropZone = document.getElementById('dropZone');
            
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                content.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            // Highlight drop area
            ['dragenter', 'dragover'].forEach(eventName => {
                content.addEventListener(eventName, () => dropZone.classList.add('active'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                content.addEventListener(eventName, () => dropZone.classList.remove('active'), false);
            });

            // Handle dropped files
            content.addEventListener('drop', handleDrop, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const files = e.dataTransfer.files;
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        addImageToContent(e.target.result, file.name);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Image drag within editor
        function handleImageDragStart(e) {
            if (!isEditMode) {
                e.preventDefault();
                return;
            }
            
            draggedElement = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleImageDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedElement = null;
        }

        // Resize functionality
        function startResize(e) {
            if (!isEditMode) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            isResizing = true;
            const img = e.target.closest('.editable-image').querySelector('img');
            const rect = img.getBoundingClientRect();
            
            resizeData = {
                img: img,
                startX: e.clientX,
                startY: e.clientY,
                startWidth: rect.width,
                startHeight: rect.height,
                direction: e.target.classList[1] // nw, ne, sw, se
            };
            
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
        }

        function handleResize(e) {
            if (!isResizing || !resizeData.img) return;
            
            const deltaX = e.clientX - resizeData.startX;
            const deltaY = e.clientY - resizeData.startY;
            
            let newWidth = resizeData.startWidth;
            let newHeight = resizeData.startHeight;
            
            switch (resizeData.direction) {
                case 'se':
                    newWidth = resizeData.startWidth + deltaX;
                    newHeight = resizeData.startHeight + deltaY;
                    break;
                case 'sw':
                    newWidth = resizeData.startWidth - deltaX;
                    newHeight = resizeData.startHeight + deltaY;
                    break;
                case 'ne':
                    newWidth = resizeData.startWidth + deltaX;
                    newHeight = resizeData.startHeight - deltaY;
                    break;
                case 'nw':
                    newWidth = resizeData.startWidth - deltaX;
                    newHeight = resizeData.startHeight - deltaY;
                    break;
            }
            
            // Maintain aspect ratio with shift key
            if (e.shiftKey) {
                const aspectRatio = resizeData.startWidth / resizeData.startHeight;
                newHeight = newWidth / aspectRatio;
            }
            
            // Set minimum size
            newWidth = Math.max(50, newWidth);
            newHeight = Math.max(50, newHeight);
            
            resizeData.img.style.width = newWidth + 'px';
            resizeData.img.style.height = newHeight + 'px';
        }

        function stopResize() {
            if (isResizing) {
                isResizing = false;
                resizeData = {};
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
                saveToUndoStack();
            }
        }

        // Image utility functions
        function replaceImage(btn) {
            const wrapper = btn.closest('.editable-image');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = wrapper.querySelector('img');
                        img.src = e.target.result;
                        img.alt = file.name;
                        saveToUndoStack();
                        showToast('Image replaced successfully!', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function duplicateImage(btn) {
            const wrapper = btn.closest('.editable-image');
            const img = wrapper.querySelector('img');
            addImageToContent(img.src, img.alt + ' (copy)');
            showToast('Image duplicated!', 'success');
        }

        function deleteImage(btn) {
            if (confirm('Are you sure you want to delete this image?')) {
                const wrapper = btn.closest('.editable-image');
                wrapper.remove();
                saveToUndoStack();
                showToast('Image deleted', 'warning');
            }
        }

        function cropImage(btn) {
            showToast('Crop feature coming soon!', 'info');
        }

        function openImageProperties(btn) {
            const wrapper = btn.closest('.editable-image');
            selectImage({ currentTarget: wrapper, stopPropagation: () => {} });
        }

        // Bulk image operations
        function alignAllImages(alignment) {
            const images = document.querySelectorAll('.editable-image');
            images.forEach(wrapper => {
                wrapper.style.textAlign = alignment;
                wrapper.style.display = 'block';
                wrapper.style.margin = '10px auto';
            });
            saveToUndoStack();
            showToast(\`All images aligned to \${alignment}\`, 'success');
        }

        function optimizeAllImages() {
            const images = document.querySelectorAll('.editable-image img');
            images.forEach(img => {
                if (img.naturalWidth > 1200) {
                    img.style.maxWidth = '1200px';
                    img.style.height = 'auto';
                }
            });
            saveToUndoStack();
            showToast('Images optimized for web!', 'success');
        }

        function resizeAllImages() {
            const size = prompt('Enter new max width (pixels):', '800');
            if (size && !isNaN(size)) {
                const images = document.querySelectorAll('.editable-image img');
                images.forEach(img => {
                    img.style.maxWidth = size + 'px';
                    img.style.height = 'auto';
                });
                saveToUndoStack();
                showToast(\`All images resized to max \${size}px width\`, 'success');
            }
        }

        // Text editing functions
        function makeAllTextEditable() {
            const textElements = document.querySelectorAll('#content h1, #content h2, #content h3, #content h4, #content h5, #content h6, #content p, #content span, #content div');
            textElements.forEach(el => {
                if (!el.classList.contains('editable')) {
                    el.classList.add('editable');
                    el.setAttribute('contenteditable', isEditMode ? 'true' : 'false');
                }
            });
            showToast('All text elements are now editable!', 'success');
        }

        function formatAllHeadings() {
            const headings = document.querySelectorAll('#content h1, #content h2, #content h3, #content h4, #content h5, #content h6');
            headings.forEach((heading, index) => {
                heading.style.color = \`hsl(\${index * 60}, 70%, 50%)\`;
                heading.style.textShadow = '2px 2px 4px rgba(0,0,0,0.3)';
            });
            saveToUndoStack();
            showToast('Headings formatted with colors!', 'success');
        }

        function fixTextSpacing() {
            const textElements = document.querySelectorAll('#content p, #content div');
            textElements.forEach(el => {
                el.style.lineHeight = '1.6';
                el.style.marginBottom = '1em';
            });
            saveToUndoStack();
            showToast('Text spacing improved!', 'success');
        }

        // Theme functions
        function applyTheme(theme) {
            const content = document.getElementById('content');
            if (theme === 'modern') {
                content.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
                content.style.background = 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)';
                content.style.borderRadius = '15px';
                content.style.padding = '30px';
            } else if (theme === 'classic') {
                content.style.fontFamily = "'Times New Roman', serif";
                content.style.background = '#ffffff';
                content.style.borderRadius = '0';
                content.style.padding = '20px';
            }
            saveToUndoStack();
            showToast(\`\${theme.charAt(0).toUpperCase() + theme.slice(1)} theme applied!\`, 'success');
        }

        function resetStyles() {
            if (confirm('Are you sure you want to reset all styles? This cannot be undone.')) {
                document.getElementById('content').style.cssText = '';
                const allElements = document.querySelectorAll('#content *');
                allElements.forEach(el => {
                    el.style.cssText = '';
                });
                saveToUndoStack();
                showToast('All styles reset!', 'warning');
            }
        }

        // Save and undo functionality
        function saveToUndoStack() {
            const content = document.getElementById('content').innerHTML;
            undoStack.push(content);
            if (undoStack.length > 20) {
                undoStack.shift(); // Keep only last 20 changes
            }
        }

        function undoChanges() {
            if (undoStack.length > 1) {
                undoStack.pop(); // Remove current state
                const previousState = undoStack[undoStack.length - 1];
                document.getElementById('content').innerHTML = previousState;
                setupEditableElements();
                showToast('Changes undone!', 'success');
            } else {
                showToast('Nothing to undo!', 'warning');
            }
        }

        function saveChanges() {
            const content = document.getElementById('content').innerHTML;
            
            // Here you would typically send this to a server
            // For now, we'll just save to localStorage
            localStorage.setItem('websiteContent', content);
            
            showToast('Changes saved successfully!', 'success');
            console.log('Content saved:', content);
        }

        function previewMode() {
            disableAllEditing();
            deselectAll();
            isEditMode = false;
            updateEditButtons();
            showToast('Preview mode - all editing disabled', 'info');
        }

        function updateEditButtons() {
            const editToggle = document.getElementById('editToggle');
            const editModeBtn = document.getElementById('editModeBtn');
            const editStatus = document.getElementById('editStatus');
            
            if (isEditMode) {
                editToggle.textContent = 'Disable Editing';
                editToggle.classList.add('active');
                editModeBtn.textContent = '🔒 Disable Editing';
                editStatus.textContent = 'Editing enabled - click elements to edit';
            } else {
                editToggle.textContent = 'Enable Editing';
                editToggle.classList.remove('active');
                editModeBtn.textContent = '📝 Enable Editing';
                editStatus.textContent = 'Click to start editing';
            }
        }

        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 's':
                            e.preventDefault();
                            saveChanges();
                            break;
                        case 'z':
                            e.preventDefault();
                            undoChanges();
                            break;
                        case 'e':
                            e.preventDefault();
                            toggleEditMode();
                            break;
                    }
                }
                
                if (e.key === 'Escape') {
                    deselectAll();
                    closeAllModals();
                }
                
                if (e.key === 'Delete' && selectedElement) {
                    if (selectedElement.classList.contains('editable-image')) {
                        if (confirm('Delete selected image?')) {
                            selectedElement.remove();
                            selectedElement = null;
                            saveToUndoStack();
                        }
                    }
                }
            });
        }

        // Modal functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = \`toast \${type}\`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
            
            // Deselect images when clicking elsewhere
            if (!e.target.closest('.editable-image') && !e.target.closest('.sidebar')) {
                deselectAll();
            }
        });

        console.log('🚀 Advanced Visual Editor fully initialized!');
    </script>
</body>
</html>
